<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Twilio Dialer Trial Test</title>
<script src="https://unpkg.com/@twilio/voice-sdk@latest/dist/twilio.min.js"></script>
</head>
<body>
<h2>Twilio Trial Dialer (Türkiye Numara)</h2>
<input type="text" id="phoneNumber" placeholder="+905452142407" value="+905452142407"/>
<button id="callBtn">Ara</button>
<button id="hangupBtn">Bitir</button>

<script>
// Mikrofon izni sor
navigator.mediaDevices.getUserMedia({ audio: true })
  .then(stream => {
    console.log("Mikrofon izni verildi");
    stream.getTracks().forEach(track => track.stop());
  })
  .catch(err => {
    console.error("Mikrofon izni reddedildi:", err);
    alert("Lütfen mikrofon izni verin!");
  });

// Twilio Token alma
async function getToken() {
  try {
    const res = await fetch("https://gettoken-1651.twil.io/path_1");
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();
    return data.token;
  } catch (err) {
    console.error("Token alınamadı:", err);
    alert("Token alınamadı! Konsolu kontrol edin.");
  }
}

let device;

// Arama başlat
document.getElementById('callBtn').onclick = async () => {
  const number = document.getElementById('phoneNumber').value;
  if (!number) return alert("Numara girin!");

  if (!device) {
    const token = await getToken();
    if (!token) return;

    device = new Twilio.Device(token, { codecPreferences: ["opus","pcmu"], fakeLocalDTMF: true });
    
    // Event logları
    device.on('ready', () => console.log("Device hazır"));
    device.on('error', err => console.error("Device error:", err));
    device.on('connect', conn => console.log("Arama başladı:", conn));
    device.on('disconnect', conn => console.log("Arama sona erdi:", conn));
  }

  console.log("Aranacak numara:", number);
  device.connect({ To: number });
};

// Aramayı sonlandır
document.getElementById('hangupBtn').onclick = () => {
  if (device) device.disconnectAll();
};
</script>
</body>
</html>
